#!/bin/bash
# Affiche l'aide si -h ou --help est présent n'importe où dans les arguments
for arg in "$@"; do
    if [[ "$arg" == "-h" || "$arg" == "--help" ]]; then
        echo "\"Generate README.md table from script help texts (-h options) in the scripts directory. Parameters: none.\""
        exit 0
    fi
done

#!/bin/bash
# Affiche l'aide si -h ou --help est présent n'importe où dans les arguments
for arg in "$@"; do
    if [[ "$arg" == "-h" || "$arg" == "--help" ]]; then
        echo "Generate README.md table from script help texts (-h options) in the scripts directory. Parameters: none."
        exit 0
    fi
done

SCRIPTS_DIR="$(dirname "$0")"

# Corrige les droits d'exécution sur tous les scripts du dossier
find "$SCRIPTS_DIR" -type f ! -name 'readme_generate' -exec chmod +x {} \;

README="$(pwd)/README.md"
# Supprime le README d'un ancien lancement s'il existe
[ -f "$README" ] && rm -f "$README"


cat > "$README" <<EOF
# Scripts disponibles

| Script | Description/Usage/Exemple |
|--------|--------------------------|
EOF

for script in "$SCRIPTS_DIR"/*; do
    # Ignore ce script lui-même et les fichiers non exécutables
    [ "$script" = "$SCRIPTS_DIR/readme_generate" ] && continue
    [ ! -x "$script" ] && continue
    name="$(basename "$script")"
    echo "Test aide : $name" 1>&2
    # Détection multi-lignes : for ... do + if ... -h sur plusieurs lignes
    if grep -zqP 'for\s+[a-zA-Z0-9_]+\s+in\s+"\$@";?\s*do[\s\S]*?if\s+\[\[.*(-h|--help)' "$script" \
    || grep -qE 'if +\[\[? +"?\$[a-zA-Z0-9_]+"? +([=]{1,2}) +(-h|--help)' "$script"; then
        # Récupère l'aide du script avec timeout pour éviter les blocages
        helpout=$(timeout 2s bash "$script" -h 2>/dev/null | head -n 10)
        # Nettoie les éventuels " et espaces en début/fin
        helpout=$(echo "$helpout" | sed 's/^"//;s/"$//;s/^ *//;s/ *$//')
        # Remplace les retours à la ligne par <br> pour le markdown
        helpout_md=$(echo "$helpout" | sed ':a;N;$!ba;s/\n/<br>/g')
        [ -z "$helpout_md" ] && helpout_md="-"
        echo "| $name | $helpout_md |" >> "$README"
    else
        echo "[WARN] $name ne gère pas l'option -h" 1>&2
        echo "| $name | - |" >> "$README"
        rm -f "$README"
        exit 1
    fi
done

echo -e "\nREADME généré automatiquement à partir des scripts du dossier scripts/." >> "$README"

# Affiche explicitement le chemin du README généré (toujours dans le dossier courant)
echo "[INFO] README généré : ./README.md"
