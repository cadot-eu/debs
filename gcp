#!/bin/bash

function show_usage (){
    printf "Usage: $0 [options ]\n"
    printf "\n"
    printf "Options:\n"
    printf " -f|--force, Force push\n"
    printf " -p|--passtest, Pass tests\n"
    printf " -h|--help, Print help\n"
    
    return 0
}



force=0
passtest=0

message="$1"

#test option force is set
for i in $@
do
    case $i in
        --force| -f)
            force=1
            shift
        ;;
        --passtest| -p)
            passtest=1
            shift
        ;;
        --help| -h)
            show_usage
        ;;
    esac
    shift
done

if [ ! -d "tests" ]; then
     passtest=1
fi

if [[ `git status --porcelain` ]] || [ $force == 1 ]  ; then
    if [ -f bin/phpunit ] && [ $passtest == 0 ] ; then
        echo "Running tests"
        CURRENT=`pwd`
        BASENAME=`basename "$CURRENT"`
        docker exec -it "$BASENAME" bin/phpunit
    fi
    if [ $? -ne 0 ]; then
        echo "ERREUR DANS LES TESTS ARRET" && exit
    else
        #sudo rm git_news.json
        #echo "{" > git_news.json
        #git log --pretty=format:'"%h":{  "subject": "%s",%n  "date": "%aD"%n },'>> git_news.json  
        #echo "}" >> git_news.json 
        #sed -i 's/},}/}}/' git_news.json 
        #sudo chown www-data: git_news.json
        git add .
        git commit -m "$message"
        git submodule foreach "git add . && git commit -m '$message'"
        git add .
        git commit -m "$message"
        git push
        git push --tags
    fi
else
    echo "no modifs ;-)"
fi
